<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:v-bind="http://www.w3.org/1999/xhtml" xmlns:v-on="http://www.w3.org/1999/xhtml">
<head>
    <title>TFTG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link th:href="@{/favicon.ico}" type="image/x-icon" rel="shortcut icon"/>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.2/css/buttons.dataTables.min.css">
    <!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.bootstrap.min.js"></script>
    <!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>-->
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.colVis.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.flash.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.0.0/dist/echarts.min.js"></script>

    <script src="https://cdn.highcharts.com.cn/highcharts/highcharts.js"></script>
    <script src="https://cdn.highcharts.com.cn/highcharts/modules/exporting.js"></script>
    <script src="https://cdn.highcharts.com.cn/highcharts/modules/oldie.js"></script>
    <script src="https://cdn.highcharts.com.cn/highcharts/modules/venn.js"></script>
    <style>
        td.dt-control {
            background: url('img/details_open.png') no-repeat center center;
            cursor: pointer;
        }

        tr.shown td.dt-control {
            background: url('img/details_close.png') no-repeat center center;
        }
    </style>
</head>
<body>
<div th:replace="inc/nav :: nav"></div>

<div class="container-fulid" style="margin-top: 10px;">
    <div class="row ">
        <div class="col-md-10 col-md-offset-1">
            <h1 style="font-size: 40px;font-weight: 600;"><span class="glyphicon glyphicon-list"></span> Result of Pathway enrichment analysis</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <table id="pathwayResult" class="table table-striped table-bordered" style="width:100%">
                <thead>
                <tr>
                    <th></th>
                    <th>Pathway ID</th>
                    <th>Pathway Name</th>
                    <th>Pathway Source</th>
                    <th>Annotated Gene</th>
                    <th>Annotated Gene Number</th>
                    <th>Total Gene Number</th>
                    <th>The Terminal TF<span class="glyphicon glyphicon-question-sign" title="The terminal TFs from these pathways."></span></th>
                    <th>TF Number</th>
                    <th>P_Value<span class="glyphicon glyphicon-question-sign" title="False discovery rate(FDR) : the corrected p-value."></span></th>
                    <th>FDR</th>
                    <th>Graph</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div th:replace="inc/nav :: pathmodel"></div>
<div th:replace="inc/footer :: footer"></div>
</body>
<script th:inline="javascript">
    function show(sampleid, state) {
        var ida = sampleid + "a";
        var ids = sampleid + "s";
        if (state == "all") {
            $("#" + ida).hide();
            $("#" + ids).show();
        } else {
            $("#" + ida).show();
            $("#" + ids).hide();
        }
    }
    var userID = [[${userID}]];
    var gene = [[${gene}]];

    function format(d,pathwayidshow) {
        console.log(d)
        console.log(pathwayidshow)
        var rows = d.data.length;

        var htmlstr = '<table cellspacing="0" width="100%" class="table table-striped table-bordered hover" id="' + d.pathwayID + '">' +
            '<caption>' + "Pathway Name: " + pathwayidshow + '</caption>' +
            '<thead><tr style="background-color: #fff;font-size: small;">' +
            '<th>TF<span class="glyphicon glyphicon-question-sign" title="The terminal TFs from this pathway."></span></th>' +
            '<th>Rank<span class="glyphicon glyphicon-question-sign" title="The total number of samples associated with this TF identified by ChIP-seq and predicted by Motif."></span></th>' +
            '<th>Annotated genes<span class="glyphicon glyphicon-question-sign" title="The average number of SEs occupied by terminal TFs from this pathway."></span></th>' +
            '<th>Annotated gene number<span class="glyphicon glyphicon-question-sign" title="The average number of SEs identified by ChIP-seq occupied by terminal TFs from this pathway."></span></th>' +
            '<th>P_Value<span class="glyphicon glyphicon-question-sign" title="Hypergeometric P value."></span></th>' +
            '<th>FDR<span class="glyphicon glyphicon-question-sign" title="False discovery rate(FDR) : the corrected p-value."></span></th><th style="display: none">Venn</th></tr></thead>' +
            '<tbody>';

        for (i = 0; i < rows; i++) {
            htmlstr += "<tr>";
            htmlstr += '<td><a target="_blank" href="browserDetail?symbol=' + d.data[i].tf+'">' + d.data[i].tf + "</a></td>";
            htmlstr += "<td>" + d.data[i].rank + "</td>";
            htmlstr += "<td>" + d.data[i].annotated_gene + "</td>";
            htmlstr += "<td>" + d.data[i].annotated_gene_number + "</td>";
            htmlstr += "<td>" + d.data[i].p_value + "</td>";
            htmlstr += "<td>" + d.data[i].fdr + "</td>";
            htmlstr += '<td style="display: none"><img src="img/venn.png" ' +
                'onclick="venngraph(\''+d.data[i].num1+'\',\''+d.data[i].num2+'\',\''+d.data[i].num3+'\',\''+d.data[i].tf+'\''+')" ' +
                'data-toggle="modal" data-target="#pathwayModal" style="width:18px"></td>';
            htmlstr += "</tr>";
        }

        htmlstr += "</tbody></table>";
        return htmlstr;
    }

    $(document).ready(function () {
        var table = $('#pathwayResult').DataTable({
            ajax: {
                url: "getpathwayresult",
                type: "GET",
                data: {"userID": userID}
            },
            "columns": [
                {
                    "className": 'dt-control',
                    "orderable": false,
                    "data": null,
                    "defaultContent": ''
                },
                {"data": "pathway_ID"},
                {"data": "pathway_name"},
                {"data": "pathway_source"},
                {"data": "annotated_gene"},
                {"data": "annotated_gene_number"},
                {"data": "total_gene_number"},
                {
                    "data": "tfsplit",
                    "render": function (data, type, row, meta) {
                        return '<p style="display: none" id="'+row.pathway_ID+'a">'+row.the_terminal_tf+'</p>'+
                            '<p id="'+row.pathway_ID+'s">'+row.the_terminal_tf_short+'</p>';
                    }
                },
                {"data": "tf_number"},
                {"data": "p_value"},
                {"data": "fdr"},
                {"data": "pathway_ID",
                    "render": function (data, type, row, meta) {
                        return '<img src="img/seq.png" onclick="pathwaygraph(\''+row.id+'\',\''+row.tertf+'\')" ' +
                            'data-toggle="modal" data-target="#pathwayModal" style="width: 25px">';
                    }
                }
            ],
            columnDefs : [ {
                targets : 0,
                "orderable" : false
            } ],
            "order" : [ [ 1, 'asc' ] ]
        });

        // Add event listener for opening and closing details
        $('#pathwayResult tbody').on('click', 'td.dt-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row( tr );

            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                var tf = row.data().the_terminal_tf;
                var pathwayidshow = row.data().pathway_ID;
                console.log(row)
                var data = {
                    "userID": userID,
                    "gene":gene,
                    "tf": tf
                };
                var rowdata;
                $.ajax({
                    url: "getchildTable",
                    data: data,
                    async: false,
                    success: function (_data) {
                        rowdata = _data;
                    },
                    dataType: "json"
                });
                // Open this row
                row.child( format(rowdata,pathwayidshow) ).show();
                tr.addClass('shown');
            }
        } );
    });


    function pathwaygraph(pathwayid, tfs) {
        $.get("pathwaygraph", {pathwayid: pathwayid, tfs: tfs}, function (_data) {
            network(_data,pathwayid)
        }, "json");
    }


    function network(graph,pathwayid) {
        $("#pathwaygraph").empty();
        var div = "<div id='main' style='width: 568px;height: 500px;'></div>";
        $("#pathwaygraph").html(div);
        console.log(pathwayid)
        $("#title").text("The terminal TFs of "+pathwayid);
        var myChart = echarts.init(document.getElementById("main"));
        option = {
            title: {
                text: '',
                subtext: '',
                top: 'bottom',
                left: 'right'
            },
            tooltip: {},
            legend: [{
                orient: 'vertical',
                left: 'right',
                data: graph.categories.map(function (a) {
                    return a.name;
                })
            }],
            animationDuration: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [
                {
                    name: '',
                    type: 'graph',
                    layout: 'force',
                    data: graph.node,
                    links: graph.edge,
                    categories: graph.categories,
                    roam: true,
                    focusNodeAdjacency: true,
                    itemStyle: {
                        normal: {
                            borderColor: '#fff',
                            borderWidth: 1,
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        }
                    },
                    emphasis: {
                        lineStyle: {
                            width: 10
                        }
                    },
                    symbolSize: 20,
                    label: {
                        normal: {
                            show: true,
                            position: "top",
                            textStyle: {
                                fontSize: 10,
                                color: "black",

                            },
                        },
                        position: 'center',
                        formatter: '{b}'
                    },
                    force: {
                        layoutAnimation: false,
                        repulsion: 150
                    },
                    lineStyle: {
                        color: '#d1d1d1',
                        curveness: 0
                    }
                }
            ]
        };
        myChart.setOption(option);
    }

    function venngraph(num1,num2,num3,tf){
        console.log(num1)
        console.log(tf)
        $("#pathwaygraph").empty();
        var div = "<div id='container' style='width: 568px;height: 500px;'></div>";
        $("#pathwaygraph").html(div);
        $("#title").text(tf);
        var data = [{sets: ['bg'],value: parseInt(num1)},
            {sets: ['gene'],value: parseInt(num2)},
            {sets: ['bg', 'gene'],value: parseInt(num3),name: 'More expensive'}
        ]
        Highcharts.chart('container', {
            series: [{
                type: 'venn',
                name: '',
                data: data
            }],
            title: {
                text: ''
            }
        });
    }



</script>
</html>